
# GitHub CLI ì„¤ì¹˜ ë° ì¸ì¦ í™•ì¸
[group('git')]
check-gh:
    #!/usr/bin/env bash
    set -euo pipefail

    echo "ðŸ” GitHub CLI ì„¤ì¹˜ ìƒíƒœ í™•ì¸ ì¤‘..."
    if ! command -v gh &> /dev/null; then
        echo "âŒ GitHub CLI (gh)ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        echo ""
        echo "ðŸ“¦ ì„¤ì¹˜ ë°©ë²•:"
        echo "  brew install gh"
        echo ""
        echo "ì„¤ì¹˜ í›„ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”:"
        echo "  gh auth login"
        echo ""
        echo "ìžì„¸í•œ ì •ë³´: https://cli.github.com/"
        exit 1
    fi
    echo "âœ… GitHub CLIê°€ ì„¤ì¹˜ë˜ì–´ ìžˆìŠµë‹ˆë‹¤."

    echo ""
    echo "ðŸ” GitHub CLI ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘..."
    if ! gh api user &> /dev/null; then
        echo "âŒ GitHub CLIì— ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        echo "ë¡œê·¸ì¸ ë°©ë²•: gh auth login"
        exit 1
    fi
    echo "âœ… GitHub CLIê°€ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤."

# ê¸°ì¡´ ruleset í™•ì¸
[group('git')]
check-rulesets:
    #!/usr/bin/env bash
    set -euo pipefail

    REMOTE_URL=$(git remote get-url origin)
    if [[ $REMOTE_URL == git@github.com:* ]]; then
        REPO_PATH="${REMOTE_URL#git@github.com:}"
        REPO_PATH="${REPO_PATH%.git}"
    else
        REPO_PATH="${REMOTE_URL#https://github.com/}"
        REPO_PATH="${REPO_PATH%.git}"
    fi

    echo ""
    echo "ðŸ” ê¸°ì¡´ ruleset í™•ì¸ ì¤‘..."

    RULESETS=$(gh api "repos/$REPO_PATH/rulesets" 2>/dev/null || echo "[]")

    if [ "$RULESETS" != "[]" ]; then
        echo "âœ… ê¸°ì¡´ rulesetì´ ì¡´ìž¬í•©ë‹ˆë‹¤:"
        echo "$RULESETS" | jq -r '.[] | "  - \(.name) (ID: \(.id))"'
    else
        echo "â„¹ï¸  ê¸°ì¡´ rulesetì´ ì—†ìŠµë‹ˆë‹¤."
    fi

# GitHub repository ruleset ì„¤ì • (ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸)
[group('git')]
update-ruleset:
    #!/usr/bin/env bash
    set -euo pipefail

    echo "ðŸš€ GitHub Repository Ruleset ì„¤ì • ìŠ¤í¬ë¦½íŠ¸"
    echo "=================================================="

    # Repository ì •ë³´ ì¶”ì¶œ
    REMOTE_URL=$(git remote get-url origin)
    if [[ $REMOTE_URL == git@github.com:* ]]; then
        REPO_PATH="${REMOTE_URL#git@github.com:}"
        REPO_PATH="${REPO_PATH%.git}"
    else
        REPO_PATH="${REMOTE_URL#https://github.com/}"
        REPO_PATH="${REPO_PATH%.git}"
    fi

    echo ""
    echo "ðŸ“ Repository: $REPO_PATH"

    # ê¸°ì¡´ ruleset í™•ì¸
    echo ""
    echo "ðŸ” ê¸°ì¡´ ruleset í™•ì¸ ì¤‘..."
    RULESETS=$(gh api "repos/$REPO_PATH/rulesets" 2>/dev/null || echo "[]")
    RULESET_ID=$(echo "$RULESETS" | jq -r '.[] | select(.name == "Default Branch Protection") | .id' | head -n1)

    if [ -n "$RULESET_ID" ] && [ "$RULESET_ID" != "null" ]; then
        echo "ðŸ”„ 'Default Branch Protection' rulesetì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. (ID: $RULESET_ID)"
        ACTION="ì—…ë°ì´íŠ¸"
        METHOD="PUT"
        ENDPOINT="repos/$REPO_PATH/rulesets/$RULESET_ID"
    else
        echo "ðŸ“ ìƒˆë¡œìš´ rulesetì„ ìƒì„±í•©ë‹ˆë‹¤."
        ACTION="ìƒì„±"
        METHOD="POST"
        ENDPOINT="repos/$REPO_PATH/rulesets"
    fi

    # Ruleset ì„¤ì • JSON ìƒì„±
    cat > /tmp/github_ruleset.json << 'RULESET_EOF'
    {
      "name": "Default Branch Protection",
      "target": "branch",
      "enforcement": "active",
      "conditions": {
        "ref_name": {
          "include": ["~DEFAULT_BRANCH"],
          "exclude": []
        }
      },
      "rules": [
        {
          "type": "pull_request",
          "parameters": {
            "dismiss_stale_reviews_on_push": true,
            "require_code_owner_review": false,
            "require_last_push_approval": false,
            "required_approving_review_count": 1,
            "required_review_thread_resolution": false,
            "allowed_merge_methods": ["squash"]
          }
        },
        {
          "type": "non_fast_forward",
          "parameters": {}
        },
        {
          "type": "deletion",
          "parameters": {}
        }
      ],
      "bypass_actors": [
        {
          "actor_type": "RepositoryRole",
          "bypass_mode": "pull_request",
          "actor_id": 5
        }
      ]
    }
    RULESET_EOF

    # Ruleset ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
    echo ""
    echo "ðŸ“ ê¸°ë³¸ ruleset ${ACTION} ì¤‘..."
    gh api "$ENDPOINT" --method "$METHOD" --input /tmp/github_ruleset.json
    echo "âœ… Rulesetì´ ì„±ê³µì ìœ¼ë¡œ ${ACTION}ë˜ì—ˆìŠµë‹ˆë‹¤!"

    # Squash merge ì„¤ì •
    echo ""
    echo "ðŸ“ Squash merge ì„¤ì • ì¤‘..."
    cat > /tmp/github_squash.json << 'SQUASH_EOF'
    {
      "allow_squash_merge": true,
      "allow_merge_commit": false,
      "allow_rebase_merge": false,
      "delete_branch_on_merge": true,
      "squash_merge_commit_title": "PR_TITLE",
      "squash_merge_commit_message": "PR_BODY"
    }
    SQUASH_EOF

    gh api "repos/$REPO_PATH" --method PATCH --input /tmp/github_squash.json
    echo "âœ… Squash mergeê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!"

    # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
    rm -f /tmp/github_ruleset.json /tmp/github_squash.json

    echo ""
    echo "=================================================="
    echo "ðŸŽ‰ GitHub repository ruleset ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
    echo "ðŸŒ í™•ì¸: https://github.com/$REPO_PATH/settings/rules"

# Alias clean-branches
[group('git')]
cleanb: clean-branches

# ë¸Œëžœì¹˜ ì •ë¦¬ (main, master, develop, staging, release ì œì™¸)
[group('git')]
clean-branches:
    #!/usr/bin/env bash
    set -euo pipefail

    # ë³´í˜¸í•  ë¸Œëžœì¹˜ ëª©ë¡
    PROTECTED_BRANCHES="main|master|develop|staging|release"

    echo "ðŸ§¹ ë¸Œëžœì¹˜ ì •ë¦¬ ì¤‘..."
    echo "=================================================="
    echo ""

    git branch | grep -Ev "(^\*|$PROTECTED_BRANCHES)" | xargs --no-run-if-empty git branch -D

    echo ""
    echo "=================================================="
    echo "ðŸŽ‰ ë¸Œëžœì¹˜ ì •ë¦¬ ì™„ë£Œ!"

# Alias quick-push
[group('git')]
qp: quick-push

# ë¹ ë¥¸ push
[group('git')]
quick-push:
    #!/usr/bin/env bash
    set -euo pipefail

    echo "ðŸ§¹ ë¹ ë¥¸ í‘¸ì‰¬ ì¤‘..."
    echo "=================================================="
    echo ""

    git pull
    git add .
    git commit -m "update"
    git push

    echo ""
    echo "=================================================="
    echo "ðŸŽ‰ ë¹ ë¥¸ í‘¸ì‰¬ ì™„ë£Œ!"

# GitHub Labels ë™ê¸°í™”
[group('git')]
update-labels:
    #!/usr/bin/env bash
    set -euo pipefail

    JUST_DIR="{{justfile_directory()}}"

    echo "ðŸ·ï¸  GitHub Labels ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸"
    echo "=================================================="

    # Repository ì •ë³´ ì¶”ì¶œ
    REMOTE_URL=$(git remote get-url origin)
    if [[ $REMOTE_URL == git@github.com:* ]]; then
        REPO_PATH="${REMOTE_URL#git@github.com:}"
        REPO_PATH="${REPO_PATH%.git}"
    else
        REPO_PATH="${REMOTE_URL#https://github.com/}"
        REPO_PATH="${REPO_PATH%.git}"
    fi

    echo ""
    echo "ðŸ“ Repository: $REPO_PATH"

    # github-label-sync ì„¤ì¹˜ í™•ì¸
    echo ""
    echo "ðŸ” github-label-sync ì„¤ì¹˜ í™•ì¸ ì¤‘..."
    if [ ! -f "$JUST_DIR/node_modules/.bin/github-label-sync" ]; then
        echo "ðŸ“¦ github-label-sync ì„¤ì¹˜ ì¤‘..."
        npm install --prefix "$JUST_DIR" github-label-sync
    fi
    echo "âœ… github-label-syncê°€ ì„¤ì¹˜ë˜ì–´ ìžˆìŠµë‹ˆë‹¤."

    # GitHub í† í° ê°€ì ¸ì˜¤ê¸°
    echo ""
    echo "ðŸ”‘ GitHub í† í° ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
    GITHUB_TOKEN=$(gh auth token)
    if [ -z "$GITHUB_TOKEN" ]; then
        echo "âŒ GitHub í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        echo "gh auth loginìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”."
        exit 1
    fi
    echo "âœ… GitHub í† í°ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤."

    # Labels ë™ê¸°í™”
    echo ""
    echo "ðŸ”„ Labels ë™ê¸°í™” ì¤‘..."
    "$JUST_DIR/node_modules/.bin/github-label-sync" \
        --access-token "$GITHUB_TOKEN" \
        --labels "$JUST_DIR/labels.json" \
        "$REPO_PATH"

    echo ""
    echo "=================================================="
    echo "ðŸŽ‰ GitHub Labels ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
    echo "ðŸŒ í™•ì¸: https://github.com/$REPO_PATH/labels"